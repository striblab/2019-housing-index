
<div class="place-details">
  <h3>{ name }</h3>

  <div class="place-index">
      <Histogram
        figureClass="metro-index-chart"
        title="Metro area cities ranked by hot housing index"
        noLabel="{ true }"
        noCaption="{ true }"
        xLabel="Ranking"
        yLabel="Index"
        yMin="0"
        colors="{ [metroColor, placeColor] }"
        dataConfig="{{
          xs: {
            'Index': 'Ranking',
            'Place': 'Ranking'
          },
          columns: [
            ['Ranking'].concat(ranked.map(d => d.i)),
            ['Index'].concat(ranked.map(d => d.index))
          ],
          color: indexChartColorWrapper(id, ranked, metroColor, placeColor),
          type: 'bar'
        }}"
        redraw="{ true }"
      >Chart showing each city in the Twin Cities area metro and where they fall on the Star Tribune Hot Housing Index.</Histogram>
  </div>

  <div class="row">
    <div class="col col-66">
      <p class="data-copy">
        Located in <span>{ county } County</span>,
        <span>{ name }</span>

        {#if rank}
          ranked <span><strong>{ rank }</strong></span> on the Star Tribune's Hot Housing Index for 2018.
        {:else}
          <span><strong>was not included</strong></span> in the Star Tribune's Hot Housing Index for 2018 due to an insufficent number of sales.
        {/if}

        {#if pricePerSqFtChange || pricePerSqFtChange === 0}
          Average price per square foot was
          {#if pricePerSqFtChange === 0}
            about the same
          {:else}
            { pricePerSqFtChange > 0 ? 'up' : 'down' }
            <span>{ formatPercent(pricePerSqFtChange) } percent</span>
          {/if}
          compared to previous four-year average.
        {/if}

        {#if daysOnMarketChange || daysOnMarketChange === 0}
          Houses sold, on average,
          {#if daysOnMarketChange === 0}
            about the same when compared to the previous year.
          {:else}
            <span>{  Math.round(daysOnMarketChange) } days</span>
            { daysOnMarketChange > 0 ? 'faster' : 'slower' }
            than the previous year.
          {/if}
        {/if}

        {#if perPriceRecieved || perPriceRecieved === 0}
          Sellers got, on average, <span>{ formatPercent(perPriceRecieved) } percent</span> of their original list price.
        {/if}

        {#if perNewConstruction || perNewConstruction === 0}
          About <span>{ formatPercent(perNewConstruction) } percent</span> of the <span>{ closedSales.toLocaleString() }</span> sales were from new construction and <span>{ formatPercent(perDistressed) }</span> where short sales or foreclosures.
        {/if}
      </p>
    </div>

    <div class="col col-33">
      <figure>
        <div class="placeholder placeholder-chart">Locator map</div>
        <figcaption>Caption...</figcaption>
      </figure>
    </div>
  </div>

  <h4>Real-estate market data</h4>

  <div class="row">
    <div class="col col-50">
      <Line
        title="Price per square foot"
        xLabel="Year"
        yLabel="Price per square foot"
        yMin="0"
        colors="{ [placeColor, metroColor] }"
        dataConfig="{{
          xs: {
            'Place': 'Year',
            'Metro': 'Year'
          },
          columns: [
            ['Year'].concat(pricePerSqFtPerYear.map(d => d.year)),
            ['Place'].concat(pricePerSqFtPerYear.map(d => d.data)),
            ['Metro'].concat(metro.pricePerSqFtPerYear.map(d => d.data))
          ]
        }}"
      />
    </div>

    <div class="col col-50">
      <Line
        title="Days on market"
        xLabel="Year"
        yLabel="Days on market"
        yMin="0"
        colors="{ [placeColor, metroColor] }"
        dataConfig="{{
          xs: {
            'Place': 'Year',
            'Metro': 'Year'
          },
          columns: [
            ['Year'].concat(daysOnMarketPerYear.map(d => d.year)),
            ['Place'].concat(daysOnMarketPerYear.map(d => d.data)),
            ['Metro'].concat(metro.daysOnMarketPerYear.map(d => d.data))
          ]
        }}"
      />
    </div>
  </div>

  <div class="row">
    <div class="col col-50">
      <Line
        title="Closed sales by year for { name }"
        xLabel="Year"
        yLabel="Closed sales"
        yMin="0"
        colors="{ [placeColor, metroColor] }"
        dataConfig="{{
          xs: {
            'Closed sales': 'Year'
          },
          columns: [
            ['Year'].concat(closedPerYear.map(d => d.year)),
            ['Closed sales'].concat(closedPerYear.map(d => d.data))
          ]
        }}"
      />
    </div>

    <div class="col col-50">
      <Line
        title="Inventory for { name }"
        xLabel="Year"
        yLabel="Inventory"
        yMin="0"
        colors="{ [placeColor, metroColor] }"
        dataConfig="{{
          xs: {
            'Inventory': 'Year'
          },
          columns: [
            ['Year'].concat(inventoryPerYear.map(d => d.year)),
            ['Inventory'].concat(inventoryPerYear.map(d => d.data))
          ]
        }}"
      />
    </div>
  </div>

  <h4>About this place</h4>

  <div class="row">
    <div class="col col-50">
      <Histogram
        title="Median value of owner-occupied homes"
        xLabel="Median home value"
        yLabel="Number of places"
        yMin="0"
        yMax="{ maxBy(index.stats.medianHomeValue.histogram, 'count').count * 1.15 }"
        colors="{ [metroColor, placeColor] }"
        dataConfig="{{
          xs: {
            'Number of places': 'Median home value'
          },
          columns: [
            ['Median home value'].concat(index.stats.medianHomeValue.histogram.map(d => (d.min + d.max) / 2)),
            ['Number of places'].concat(index.stats.medianHomeValue.histogram.map(d => d.count))
          ],
          type: 'bar'
        }}"
        xTickFormat="{ d => { return `$${Math.round(d / 1000)}k`; }}"
        lineAnnotationOptions="{ medianHomeValue ? (chart) => {
          return {
            x1: chart.internal.x(medianHomeValue),
            y1: chart.internal.y(maxBy(index.stats.medianHomeValue.histogram, 'count').count * 1.15),
            x2: chart.internal.x(medianHomeValue),
            y2: chart.internal.y(0),
            textx: chart.internal.x(medianHomeValue * 1.07),
            texty: chart.internal.y(maxBy(index.stats.medianHomeValue.histogram, 'count').count * 1),
            text: name
          }
        } : undefined }"
        redraw="{ true }"
      >
        {#if medianHomeValue}
          Median home value in { name } is ${ medianHomeValue.toLocaleString() }
        {/if}
      </Histogram>
    </div>

    <div class="col col-50">
      <Histogram
        title="Median household income"
        xLabel="Median household income"
        yLabel="Number of places"
        yMin="0"
        yMax="{ maxBy(index.stats.medianHouseholdIncome.histogram, 'count').count * 1.15 }"
        colors="{ [metroColor, placeColor] }"
        dataConfig="{{
          xs: {
            'Number of places': 'Median household income'
          },
          columns: [
            ['Median household income'].concat(index.stats.medianHouseholdIncome.histogram.map(d => (d.min + d.max) / 2)),
            ['Number of places'].concat(index.stats.medianHouseholdIncome.histogram.map(d => d.count))
          ],
          type: 'bar'
        }}"
        xTickFormat="{ d => { return `$${Math.round(d / 1000)}k`; }}"
        lineAnnotationOptions="{ medianHouseholdIncome ? (chart) => {
          return {
            x1: chart.internal.x(medianHouseholdIncome),
            y1: chart.internal.y(maxBy(index.stats.medianHouseholdIncome.histogram, 'count').count * 1.15),
            x2: chart.internal.x(medianHouseholdIncome),
            y2: chart.internal.y(0),
            textx: chart.internal.x(medianHouseholdIncome * 1.07),
            texty: chart.internal.y(maxBy(index.stats.medianHouseholdIncome.histogram, 'count').count * 1),
            text: name
          }
        } : undefined }"
        redraw="{ true }"
      >
        {#if medianHouseholdIncome}
          Median household income in { name } is ${ medianHouseholdIncome.toLocaleString() }
        {/if}
      </Histogram>
    </div>

    <div class="col col-50">
      <Histogram
        title="Percent owner-occupied homes"
        xLabel="Percent owner-occupied homes"
        yLabel="Number of places"
        yMin="0"
        yMax="{ maxBy(index.stats.perOwnerOccupied.histogram, 'count').count * 1.15 }"
        colors="{ [metroColor, placeColor] }"
        dataConfig="{{
          xs: {
            'Number of places': 'Percent owner-occupied homes'
          },
          columns: [
            ['Percent owner-occupied homes'].concat(index.stats.perOwnerOccupied.histogram.map(d => (d.min + d.max) / 2)),
            ['Number of places'].concat(index.stats.perOwnerOccupied.histogram.map(d => d.count))
          ],
          type: 'bar'
        }}"
        xTickFormat="{ d => { return `${Math.round(d * 10000) / 100}%`; }}"
        lineAnnotationOptions="{ perOwnerOccupied ? (chart) => {
          return {
            x1: chart.internal.x(perOwnerOccupied),
            y1: chart.internal.y(maxBy(index.stats.perOwnerOccupied.histogram, 'count').count * 1.15),
            x2: chart.internal.x(perOwnerOccupied),
            y2: chart.internal.y(0),
            textx: chart.internal.x(perOwnerOccupied * 1.07),
            texty: chart.internal.y(maxBy(index.stats.perOwnerOccupied.histogram, 'count').count * 1),
            text: name
          }
        } : undefined }"
        redraw="{ true }"
      >
        {#if perOwnerOccupied}
          Percent owner-occupied homes in { name } is { Math.round(perOwnerOccupied * 10000) / 100 }%
        {/if}
      </Histogram>
    </div>

    <div class="col col-50">
      <Histogram
        title="Percent cost-burdened owners"
        xLabel="Percent cost-burdened owners"
        yLabel="Number of places"
        yMin="0"
        yMax="{ maxBy(index.stats.perCostBurdened.histogram, 'count').count * 1.15 }"
        colors="{ [metroColor, placeColor] }"
        dataConfig="{{
          xs: {
            'Number of places': 'Percent cost-burdened owners'
          },
          columns: [
            ['Percent cost-burdened owners'].concat(index.stats.perCostBurdened.histogram.map(d => (d.min + d.max) / 2)),
            ['Number of places'].concat(index.stats.perCostBurdened.histogram.map(d => d.count))
          ],
          type: 'bar'
        }}"
        xTickFormat="{ d => { return `${Math.round(d * 10000) / 100}%`; }}"
        lineAnnotationOptions="{ perCostBurdened ? (chart) => {
          return {
            x1: chart.internal.x(perCostBurdened),
            y1: chart.internal.y(maxBy(index.stats.perCostBurdened.histogram, 'count').count * 1.15),
            x2: chart.internal.x(perCostBurdened),
            y2: chart.internal.y(0),
            textx: chart.internal.x(perCostBurdened * 1.05),
            texty: chart.internal.y(maxBy(index.stats.perCostBurdened.histogram, 'count').count * 1.1),
            text: name
          }
        } : undefined }"
        redraw="{ true }"
      >
        {#if perCostBurdened}
          Percent cost-burdened owners in { name } is { Math.round(perCostBurdened * 10000) / 100 }%
        {/if}
      </Histogram>
    </div>
  </div>
</div>

<script>
  import Histogram from "./_chart-histogram.svelte.html";
  import Line from "./_chart-line.svelte.html";
  import { isNumber, maxBy } from "lodash";

  export default {
    components: {
      Histogram,
      Line
    },

    oncreate() {},

    helpers: {
      maxBy,

      // Max with some padding
      padMax(collection, prop) {
        let f = maxBy(collection, prop);
        return f ? Math.floor(f[prop] * 1.2) : undefined;
      },

      formatPercent(input) {
        if (!isNumber(input)) {
          return "-";
        }

        input = input * 100;
        if (input < 1 && input > 0) {
          return "less than 1";
        } else if (input > -1 && input < 0) {
          return "less than 1";
        }

        return Math.round(input);
      },

      indexChartColorWrapper(id, ranked, metroColor, placeColor) {
        return (c, d, a) => {
          return ranked[d.index] && ranked[d.index].id === id
            ? placeColor
            : metroColor;
        };
      }
    },

    data() {
      return {
        // https://striblab.github.io/strib-styles/pages/content/colors.html
        placeColor: "#1d78af",
        metroColor: "#ccc900"
      };
    }
  };
</script>
