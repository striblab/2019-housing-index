<div class="chart-figure">
  <div class="label" id="label-{ id }">{ title }</div>

  <figure aria-labelledby="label-{ id }">
    <div class="chart chart-line" ref:chart role="img" title="{ title }"></div>
    <figcaption>
      <slot>Needs caption slot</slot>
    </figcaption>
  </figure>
</div>

<script>
  import LayerCake from "layercake";
  import AxisX from "./_axis-x.svelte.html";
  import AxisY from "./_axis-y.svelte.html";
  import Line from "./_line.svelte.html";
  import { isArray, flatten, omit } from "lodash";

  export default {
    oncreate() {
      let p = this.get();

      // Create layer cake store
      let lc = this.updateCreateCake();

      // Add layers
      lc.svgLayers(
        [
          {
            component: AxisX,
            opts: {
              gridlines: true,
              baseline: true,
              textAnchor: "start",
              label: p.xLabel,
              formatTick: p.formatTick
            }
          },
          {
            component: AxisY,
            opts: {
              gridlines: true,
              label: p.yLabel
            }
          }
        ].concat(
          p.data.map((d, di) => {
            return {
              component: Line,
              opts: {
                data: d,
                identifier: di
              }
            };
          })
        )
      );

      // Render
      lc.render();
    },

    // On state change
    onstate({ changed, current, previous }) {
      // let lc = this.get().layercake;
      // if (changed.data && lc) {
      //   lc.set({ data: this.get().data });
      // }
    },

    methods: {
      updateCreateCake() {
        let p = this.get();
        let cakeOptions = {
          x: p.x || "year",
          xDomain: p.xDomain,
          y: p.y || "data",
          yDomain: p.yDomain,
          data: p.data,
          flatData: flatten(p.data),
          target: this.refs.chart,
          padding: { top: 5, right: 5, bottom: 50, left: 50 }
        };

        if (p.layercake) {
          console.log(2, omit(cakeOptions, ["target", "padding"]));
          p.layercake.set(omit(cakeOptions, ["target", "padding"]));
        } else {
          console.log(1, cakeOptions);
          this.set({ layercake: new LayerCake(cakeOptions) });
        }

        return this.get().layercake;
      }
    },

    data() {
      return {
        id: `component-id-${Math.round(Math.random() * 100000)}`,
        title: "Needs title"
      };
    }
  };
</script>
